<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=0">
<meta name="format-detection" content="telephone=no">
<title>≡0v0) { ﾊﾄｶﾞﾃﾞﾙﾖ</title>
<style type="text/css"><!--
@font-face{font-family:"emj";src:local("Apple Color Emoji"),local("Noto Color Emoji");unicode-range:U+2600/*☀*/,U+263A/*☺*/,U+2764/*❤*/;}
body{color:white;background-color:black;width:100%;margin:0 auto;max-width:340px;}
*{-webkit-appearance:none;font:13px sans-serif;border-radius:0;}

textarea{color:white;background-color:#212121;letter-spacing:1px;width:100%;margin:0 0 2px;padding:3px 5px;resize:none;line-break:anywhere;}

/* ボタンパネル系 */
#cn{width:80%;}
#cn,#pn{margin:0 auto;position:relative;}
#pn,#vw{display:none;line-height:125%;}
#pr{font:13px/125% "emj","NasuM",monospace,monospace;}
button,input,select{color:white;background-color:#216651;height:26px;vertical-align:middle;margin:0;padding:0;border-style:solid;border-width:0 0 1px 1px;border-color:black;}
button,input[type="number"],input[type="color"],input[type="reset"]{text-align:center;width:20%;}
#cm>button{width:25%}
input[type="checkbox"]{width:19px;height:19px;}
input[type="checkbox"]:checked{background-color:white;border:4px solid #216651;}
select,option{width:80%;padding:0 5px;}

/* 設定パネル */
form{padding:3em 10%;background-color:#313131;}
#ptab,#atab{display:none;}
img{width:50%;margin:0 25%;}
button:disabled{background-color:#515151;}
#pr{display:none;}

/* プレビュー */
#vw{color:white;background-color:#313131;position:absolute;z-index:8;width:100%;max-width:340px;min-height:100vh;}
p{font-size:15px;margin:3em 1em;padding:1em 0;line-break:anywhere;border-style:dotted;border-color:#c7ffa9;border-width:2px 0;}
header,footer{color:#c7ffa9;background-color:#212121;text-align:center;margin:0;padding:3px;position:fixed;width:100%;max-width:334px;}
header{top:0;}
footer{bottom:0;}
#vw button{width:20%;height:26px}

/* メッセージ等 */
.hm{color:#212151;background-color:#c9c951;position:absolute;top:0;left:0;text-align:center;visibility:hidden;transform:rotate(90deg);transform-origin:0 0;}
.hm.o{visibility:visible;}
.mes{color:#f1f1f1;background-color:#216651;text-align:center;width:50%;border-radius:1em;box-shadow:0 0 9px 5px;position:fixed;top:27%;left:25%;padding:7px 0;visibility:hidden;transform-origin:0 0;opacity:0;transition:opacity 250ms, visibility 0s ease 250ms;z-index:9;}
.mes.age{visibility:visible;opacity:1;transition-delay:0s;}
#swg,#cm{display:none;}
#sw{font:12px sans-serif;}
--></style>
<link rel="manifest" href="m.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="stylesheet" type="text/css" href="wf.css">
</head><body ondblclick=";">
<!-- プレビューコンテナ --><div id="vw"></div>
<!-- メッセージコンテナ --><div id="me" class="mes"></div>
<!-- ﾊﾄｶﾞﾃﾞﾙﾉﾊｺｺﾀﾞﾖ --><textarea rows=12 cols=17 id="pr" onchange="bu()"></textarea>
<!-- コンパネ --><div id="cn"><!-- 拡張セット --><div id="cf"><button type=button onclick="si()">⤵</button><button type=button onclick="a()">「</button><button type=button onclick="u()">↑</button><button type=button onclick="m()">≫</button><button type=button onclick="o()">▼</button><button type=button onclick="gi()">⤴</button><button type=button onclick="l()">←</button><button type=button onclick="b()">～</button><button type=button onclick="g()">→</button><button type=button onclick="c()">■</button><button type=button onclick="h()">Φ</button><button type=button onclick="t()">≪</button><button type=button onclick="d()">↓</button><button type=button onclick="z()">」</button><button type=button onclick="v()">ｖ</button></div><!-- 最小セット --><div id="cm"><button type=button onclick="si()">⤵</button><button type=button onclick="a()">「</button><button type=button onclick="z()">」</button><button type=button onclick="o()">▼</button><button type=button onclick="c()">■</button><button type=button onclick="l()">←</button><button type=button onclick="g()">→</button><button type=button onclick="v()">ｖ</button></div><!-- 定型文 --><span id="swg"><select id="swl"></select><button type=button onclick="i()">＋</button></span><!-- ラベル --><span id="bm" class="hm">範囲選択</span></div>
</div>
<!-- 設定画面 --><div id="pn"><header><button type=button onclick="o(1)" disabled id="sbt">設定</button><button type=button onclick="o(2)" id="pbt">p設定</button><button type=button onclick="o(3)" id="abt">about</button><button type=button onclick="o()">▼戻る</button></header>
<!-- 通常設定 --><form id="stab"><input type="reset" value="リセット">　<button type=button onclick="st()">設定</button>
<br>
<br>テキストエリア設定
<br><input type="number" id="cr" min=5 max=20 value=12>高さ(行)
<br><input type="number" id="ft" min=8 max=39 value=13>フォントサイズ(px)
<br><input type="number" id="ls" min=0 max=9 value=1>字間(px)
<br><input type="number" id="lh" min=90 max=200 value=125>行間(%)
<br><input type="color" id="fc" value="#ffffff">文字色
<br><input type="color" id="bc" value="#212121">背景色
<br>
<br>ボタン等設定
<br><input type="number" id="bh" min=10 max=50 value=26>高さ(px)
<br>
<br><label><input type="checkbox" id="em">拡張モード</label>
<br><label><input type="checkbox" id="sc">定型文を使用</label>
<br><textarea rows=3 cols=17 id="sw"></textarea>
<br>1行1定型文
<br>改行を含める場合は『\n』で置換
<br>
<br><input type="reset" value="リセット">　<button type=button onclick="st()">設定</button></form>
<!-- プレビュー設定 --><form id="ptab"><input type="reset" value="リセット">　<button type=button onclick="hp()">設定</button>
<br>
<br>プレビュー設定
<br><select id="vff"><option value=0>ゴシック体</option><option value=1>明朝体</option></select>
<br><input type="number" id="vft" max=39 min=8 value=15>フォントサイズ(px)
<br><input type="number" id="vls" max=9 min=0 value=1>字間(px)
<br><input type="number" id="vlh" max=200 min=0 value=125>行間(%)
<br><input type="color" id="vfc" value="#ffffff">文字色
<br><input type="color" id="vbc" value="#313131">背景色
<br>
<br><label><input type="checkbox" id="vem">下記ルールで置換して表示</label>
<br><textarea rows=3 cols=17 id="vsw">^	gm	　
([！？])	g	$1　
　([「『！？』」）])	g	$1
^([！？])	gm	　$1
　$	gm	</textarea>
<br>1行1ルール
<br>patern, flags, newStringの順にタブ文字で区切る
<br>『//』で始まる行はコメント扱い
<br>（初期設定は「括弧の直前を除く行頭と！や？の末尾に全角空白を挿入する」サンプルパターン）
<br>
<br><input type="reset" value="リセット">　<button type=button onclick="hp()">設定</button></form>
<!-- アバウト --><form id="atab"><img src="i.png" alt="アイコン近影">
<br>
<br>ﾊｰﾄが出るﾃｷｽﾄｴﾘｱ
<br>「ﾊﾄﾃﾞﾘｬｰ」
<br>2022_0510_2047
<br>
<br>-動作確認：iOS15.4.1 + Safari
<br>-ホーム画面に追加すると単独アプリっぽく使える気がする
<br>
<br>!!!不意のデータクリアに備えて別途保存を推奨
<br>
<br>-データ保持はブラウザのlocalStorageを使用
<br>-textareaのonchangeで自動保存→リロード時に復元
<br>-[手動保存/手動復元]と[自動保存/リロード復元]は別データ
<br>
<br>-ｶﾝﾑﾘﾊﾞﾄﾁｬﾝｶﾜｲｲﾖ
<br>
<br>
<br>
<br>
<br>webフォント(約3MB)の使用を<button type=button id="wf" onclick="fl()">開始</button>
<br>
<br>キャッシュを破棄してページを<button type=button onclick="location.reload(true)">再読込</button>
<br>
<br>localStorageを<button type=button onclick="adel()">全削除</button>
<br>※他サイトのデータは消えません</form></div>

<script>//<!--

function hp() { //……プレビュー書式設定
	var s = document.getElementById("vff").value; //フォントファミリー
	s += ":" + document.getElementById("vft").value; //フォントサイズ(px)
	s += ":" + document.getElementById("vls").value; //字間(px)
	s += ":" + document.getElementById("vlh").value; //行間(%)
	s += ":" + document.getElementById("vfc").value; //文字色
	s += ":" + document.getElementById("vbc").value; //背景色
	s += ":" + document.getElementById("vem").checked; //置換
	localStorage.setItem('pps',s);
	hpr(s);
	s = document.getElementById("vsw").value; //置換ルール
	var a = "", b = "", c = "", i = 0;
	if(s != "" && s != null){ 
		var t = s.split("\n");
		for(i in t){
			if(/^\/\//.test(t[i]) || t[i] == ""){ //コメントと空行はスキップ
				continue;
			}
			a = t[i].split("\t");
			if(a.length < 3){
				i -= 0;
				c = c + (i + 1) + ",";
				continue;
			}
		}
		if(c != ""){
			c = c.slice(0,-1);
			if(window.confirm(c + "行目は要素が不足しています。\nこのまま設定しますか？")){
				localStorage.setItem('ppv',s);
			}
		}else{
			localStorage.setItem('ppv',s);
		}
	}
	
	mp("設定を保存しました");
}

function hpr(s) { //……プレビュー設定反映
	var s = s.split(":");
	pst = ' style="';
	if(s[0] - 0){
		pst += "font-family:serif;";
	}
	pst += "font-size:" + s[1] + "px;letter-spacing:" + s[2] + "px;line-height:" + s[3] + '%;"';
	w.style.color = s[4];
	w.style.backgroundColor = s[5];
	
}

function fl() { //……webフォント適用切り替え
	var s = document.getElementById("wf").textContent;
	if(s =="終了"){
		p.style.fontFamily = '"emj","NasuM",monospace,monospace';
		document.getElementById("wf").textContent = "開始";
		localStorage.setItem('wfl',0);
		mp("終了しました");
	}else{
		p.style.fontFamily = '"emj","webnasm"';
		document.getElementById("wf").textContent = "終了";
		localStorage.setItem('wfl',1);
		mp("開始しました");
	}
}

function mp(s) { //……メッセージポップ
	document.getElementById("me").innerHTML = s;
	document.getElementById("me").classList.toggle("age");
	setTimeout(function() {
		document.getElementById("me").classList.toggle("age");
	},1000);
}

function adel() { //……ストレージ全削除
	if(window.confirm("本当に全削除しますか？")){
		localStorage.clear();
		mp("削除しました");
	}
}

function b() { //……範囲選択モード
	if(bb){
		bb = 0;
	}else{
		bb = 1;
	}
	document.getElementById("bm").classList.toggle("o");
	p.focus();
}

function st() { //……設定変更
	var s = document.getElementById("cr").value; //[0]テキストエリア高さ(行)
	s += ":" + document.getElementById("ft").value; //[1]フォントサイズ(px)
	s += ":" + document.getElementById("ls").value; //[2]字間(px)
	s += ":" + document.getElementById("lh").value; //[3]行間(%)
	s += ":" + document.getElementById("fc").value; //[4]文字色
	s += ":" + document.getElementById("bc").value; //[5]背景色
	s += ":" + document.getElementById("bh").value; //[6]ボタン高さ(px)
	s += ":" + document.getElementById("em").checked; //[7]拡張スイッチ
	s += ":" + document.getElementById("sc").checked; //[8]定型文スイッチ
	sh(s);
	localStorage.setItem('pss',s);
	s = document.getElementById("sw").value; //定型文内容
	localStorage.setItem('psw',s);
	s = s.replace(/</g,"&lt;");
	s = s.replace(/>/g,"&gt;");
	s = s.replace(/^(.+)$/gm,"<option>$1</option>");
	r.innerHTML = s;
	mp("設定しました");
}

function sh(s) { //……設定反映
	var s = s.split(":");
	p.rows = s[0]; //テキストエリア高さ(行)
	p.style.fontSize = s[1] + "px"; //フォントサイズ(px)
	p.style.letterSpacing = s[2] + "px"; //字間(px)
	p.style.lineHeight = s[3] + "%"; //行間(%)
	p.style.color = s[4]; //文字色
	p.style.backgroundColor = s[5]; //背景色
	var i = 0; 
	for (i = 0; i < 24; i++) {//ボタン高さ(px)
		document.getElementsByTagName("button")[i].style.height = s[6] + "px";
	}
	r.style.height = s + "px"; //定型文セレクトボックス
	
	if(s[7] == true || s[7] == "true"){ //拡張スイッチ
		document.getElementById("cf").style.display = "block";
		document.getElementById("cm").style.display = "none";
	}else{
		document.getElementById("cm").style.display = "block";
		document.getElementById("cf").style.display = "none";
	}
	if(s[8] == true || s[8] == "true"){ //定型文スイッチ
		document.getElementById("swg").style.display = "inline";
	}else{
		document.getElementById("swg").style.display = "none";
	}
	return(1);
}

function i() { //……定型文挿入
	var s = r.value;
	if(s != ""){
		s = s.replace(/&lt;/g,"<");
		s = s.replace(/&gt;/g,">");
		var s1 = s.replace(/\\n/g,"\n");
		s = p.value;
		var q = p.selectionStart;
		var q1 = p.selectionEnd;
		p.value = s.slice(0,q);
		p.value += s1;
		p.value += s.slice(q1);
		p.selectionEnd = q + s1.length;
		p.selectionStart = p.selectionEnd;
	}
}

function o(a) { //……メニュー
	if(a == 1){
		document.getElementById("stab").style.display = "block";
		document.getElementById("ptab").style.display = "none";
		document.getElementById("atab").style.display = "none";
		document.getElementById("sbt").disabled = true;
		document.getElementById("pbt").disabled = false;
		document.getElementById("abt").disabled = false;
		window.scrollTo(0,0);
	}else if(a == 2){
		document.getElementById("stab").style.display = "none";
		document.getElementById("ptab").style.display = "block";
		document.getElementById("atab").style.display = "none";
		document.getElementById("sbt").disabled = false;
		document.getElementById("pbt").disabled = true;
		document.getElementById("abt").disabled = false;
		window.scrollTo(0,0);
	}else if(a == 3){
		document.getElementById("stab").style.display = "none";
		document.getElementById("ptab").style.display = "none";
		document.getElementById("atab").style.display = "block";
		document.getElementById("sbt").disabled = false;
		document.getElementById("pbt").disabled = false;
		document.getElementById("abt").disabled = true;
		window.scrollTo(0,0);
	}else{
		var s = document.getElementById("pn").style.display;
		if(s == "block"){
			p.style.display = "block";
			document.getElementById("cn").style.display = "block";
			document.getElementById("pn").style.display = "none";
			localStorage.setItem('pn',0);
		}else{
			document.getElementById("pn").style.display = "block";
			p.style.display = "none";
			document.getElementById("cn").style.display = "none";
			localStorage.setItem('pn',1);
		}
	}
}

function si() { //……保存
	var s = p.value;
	if(s == ""){
		mp("内容がありません");
	}else{
		if(window.confirm("保存しますか？")){
			localStorage.setItem('pvalue',s);
			bu();
			mp("保存しました");
		}
	}
	p.focus();
}

function gi() { //……復帰
	var s = localStorage.getItem('pvalue');
	if(s == "" || s ==null){
		mp("保存されていません");
	}else{
		if (window.confirm("復帰しますか？")) {
			s = p.value;
			p.value = localStorage.getItem('pvalue');
			if(s == ""){
				mp("復帰しました");
			}else{
				localStorage.setItem('pvalue',s);
				mp("内容を入れ替えました");
			}
		}
	}
	p.focus();
}

function c() { //……全文コピー
	if(window.confirm("全文コピーしますか？")){
		var q = p.selectionEnd;
		p.select();
		try{
			document.execCommand('copy');
			mp("コピーしました");
		}catch(e){
			alert("実行できませんでした\n" + e);
		}
		p.setSelectionRange(q,q);
	}
	p.blur();
}

function t() { //……左端
	p.focus();
	var s = p.value;
	var q = p.selectionEnd;
	if(bb && p.selectionDirection == "backward"){
		q = p.selectionStart;
	}
	
	var s1 = s.slice(0,q);
	s1 = s1.split("\n");
	s1.reverse();
	s1 = ar(s1[0]); //キャレット行
	s1.reverse();
	q -= s1[0].length;
	
	if(bb){
		if(p.selectionDirection == "backward"){
			p.selectionStart = q;
		}else{
			if(q < p.selectionStart){
				p.setSelectionRange(q,p.selectionStart,"backward");
			}else{
				p.selectionEnd = q;
			}
		}
	}else{
		p.setSelectionRange(q,q);
	}
}

function m() { //……右端
	p.focus();
	var s = p.value;
	var q = p.selectionEnd;
	if(bb && p.selectionDirection == "backward"){
		q = p.selectionStart;
	}
	
	var s1 = s.slice(0,q);
	s1 = s1.split("\n");
	s1.reverse();
	var s0 = ar(s1[0]); //行頭～キャレット
	s0.reverse();
	var q1 =  q - s0[0].length //左端～キャレット
	s1 = s.slice(q1);
	s1 = s1.split("\n");
	s1 = ar(s1[0]); //左端～行末
	q1 += s1[0].length; //左端～右端
	if(q == q1 && 1 in s1){
		q1 += s1[1].length; 
	}
	q = q1;
	
	if(bb){
		if(p.selectionDirection == "backward"){
			if(q > p.selectionEnd){
				p.setSelectionRange(p.selectionEnd,q,"forward");
			}else{
				p.selectionStart = q;
			}
		}else{
			p.selectionEnd = q;
		}
	}else{
		p.setSelectionRange(q,q);
	}
}

function a() { //……文頭
	p.focus();
	if(bb){
		if(p.selectionDirection == "backward"){
			p.selectionStart = 0;
		}else{
			p.setSelectionRange(0,p.selectionStart,"backward");
		}
	}else{
		p.setSelectionRange(0,0);
	}
	p.scrollTop = 0;
}

function l() { //……左
	p.focus();
	if(bb){
		if(p.selectionDirection == "backward"){
				p.selectionStart--;
		}else{
			if(p.selectionStart == p.selectionEnd){
				p.selectionStart--;
				p.selectionDirection = "backward";
			}else{
				p.selectionEnd--;
			}
		}
	}else{
		p.selectionEnd--;
	}
}

function g() { //……右
	p.focus();
	if(bb){
		if(p.selectionDirection == "backward"){
			if(p.selectionStart == p.selectionEnd){
				p.selectionEnd++;
				p.selectionDirection = "forward";
			}else{
				p.selectionStart++;
			}
		}else{
			p.selectionEnd++;
		}
	}else{
		p.selectionStart++;
	}
}

function z() { //……文末
	p.focus();
	var s = p.value;
	var q = s.length;
	if(bb){
		if(p.selectionDirection == "backward"){
			p.setSelectionRange(p.selectionEnd,q,"forward");
		}else{
			p.selectionEnd = q;
		}
	}else{
		p.setSelectionRange(q,q);
	}
	p.scrollTop = p.scrollHeight;
}

function v() { //……鳩
	var s = p.value;
	var q = p.selectionStart;
	var q1 = p.selectionEnd;
	p.value = s.slice(0,q);
	p.value += "♡";
	p.value += s.slice(q1);
	p.selectionEnd = q + 1;
	p.selectionStart = p.selectionEnd;
}

function al(s1,s2) { //……文字数カウント
	var s = s1.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]|[^\uD800-\uDFFF]/g)||[];
	if(s2 != 1){
		s = s.length * 2;
		s -= (s1.match(/[\x20-\x7e]/g)||[]).length
	}else{
		s = s.length;
	}
	return(s);
}

function ar(s1) { //……改行配列作成
	var s1 = s1.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]|[^\uD800-\uDFFF]/g)||[];
	var s2 = 0;
	var s3 = "";
	var s4 = 0;
	var s5 = 0;
	var s6 = [""];
	var p1 = p.style.fontSize.slice(0,-2) - 0;
	var p2 = (p.style.letterSpacing.slice(0,-2) - 0) * 2;
	var p3 = (p.clientWidth - 10) * 2;
	for(s3 in s1){
		if(/[\x20-\x7e]/.test(s1[s3])){ //半角
			s4 = p1 + p2;
		}else{ //全角
			s4 = p1 + p1 + p2;
		}
		if((s2 + s4) > p3){ //あふれたら改行
			s2 = s4;
			s5++;
			s6[s5] = s1[s3];
		}else{
			s2 += s4;
			s6[s5] += s1[s3];
		}
	}
	return(s6);
}

function u() { //……上キー
	p.focus();
	var i = 0, s = p.value, q = p.selectionEnd, s3 = 0, s4 = 0;
	if(bb && p.selectionDirection == "backward"){
		q = p.selectionStart;
	}
	var s1 = s.slice(0,q);
	s1 = s1.split("\n");
	s1.reverse();
	var s0 = ar(s1[0]); //キャレット行
	s0.reverse();
	if(1 in s1){
		s1 = ar(s1[1]); //前行
		s1.reverse();
	}else{
		s1 = -1;
	}
	var s2 = al(s0[0]); //左端～キャレット
	if(s2 % 2 >0){
		s2++;
	}
	
	var s5 = s.slice(0,q + 1);
	if(s.charAt(q) != "\n"){
		s5 = s5.split("\n");
		s5.reverse();
		s5 = ar(s5[0]);
		s5 = s5.length - s0.length; //右端チェック
	}
	if(s5 > 0 && s0.length == 1){ //キャレットが行の2段目左端だった場合
		s0.unshift("");
		s5 = -1;
	}
	if(1 in s0){ //行内で移動可能
		s3 = s0[1].match(/[\uD800-\uDBFF][\uDC00-\uDFFF]|[^\uD800-\uDFFF]/g)||[];
		for(i in s3){
			i++;
			s4 = s3.slice(0,i);
			i--;
			s4 = s4.join("");
			if(al(s4) > s2){
				s4 = s3.slice(i);
				s4 = s4.join("");
				break;
			}
			if(s5 > 0){
				s4 = "";
			}
		}
		q = q - s4.length - s0[0].length;
	}else if(s1 == -1){ //キャレット行が最前
		q = q - s0[0].length;
	}else if(s1[0] == ""){ //前行が空行
		q = q - s0[0].length - 1;
	}else{
		s3 = s1[0].match(/[\uD800-\uDBFF][\uDC00-\uDFFF]|[^\uD800-\uDFFF]/g)||[];
		for(i in s3){
			i++;
			s4 = s3.slice(0,i);
			i--;
			s4 = s4.join("");
			if(al(s4) > s2){
				s4 = s3.slice(i);
				s4 = s4.join("");
				break;
			}
			s4 = "";
		}
		q = q - s4.length - s0[0].length - 1;
	}
	
	if(bb){
		if(p.selectionDirection == "backward"){
			p.selectionStart = q;
		}else{
			if(q < p.selectionStart){
				p.setSelectionRange(q,p.selectionStart,"backward");
			}else{
				p.selectionEnd = q;
			}
		}
	}else{
		p.setSelectionRange(q,q);
	}
	console.log(q);
}

function d() { //……下キー
	p.focus();
	var i = 0, s = p.value, q = p.selectionEnd, s3 = 0, s4 = 0;
	if(bb && p.selectionDirection == "backward"){
		q = p.selectionStart;
	}
	var s1 = s.slice(0,q);
	s1 = s1.split("\n");
	s1.reverse();
	var s0 = ar(s1[0]); //行頭～キャレット行
	s0.reverse();
	var s2 = al(s0[0]); //左端～キャレット
	
	var s5 = s.slice(0,q + 1);
	if(s.charAt(q) != "\n"){
		s5 = s5.split("\n");
		s5.reverse();
		s5 = ar(s5[0]);
		s5 = s5.length - s0.length; //右端チェック
	}else{
		s5 = -1;
	}
	
	q -= s0[0].length //キャレット行左端
	s1 = s.slice(q);
	s1 = s1.split("\n"); //～文末
	s0 = ar(s1[0]); //～行末
	
	if(s5 > 0 && s0.length == 2){ //キャレットが行の最下段左端だった場合
		s0.shift();
		s2 = 0;
	}
	
	if(1 in s0){ //行内で移動可能
		s3 = s0[1].match(/[\uD800-\uDBFF][\uDC00-\uDFFF]|[^\uD800-\uDFFF]/g)||[];
		for(i in s3){
			i++;
			s4 = s3.slice(0,i);
			s4 = s4.join("");
			if(al(s4) >= s2){
				if(i == 1 && s2 == 0){
					s4 = "";
//					break;
				}
//これいらなくね？
//				s4 = s3.slice(0,i);
//				s4 = s4.join("");
				break;
			}
		}
		q = q + s4.length + s0[0].length;
	}else if(1 in s1){ //キャレット行が最終
		if(s1[1] == ""){ //次行が空行
			q = q + s1[0].length + 1;
		}else{
			s3 = s1[1].match(/[\uD800-\uDBFF][\uDC00-\uDFFF]|[^\uD800-\uDFFF]/g)||[];
			for(i in s3){
				i++;
				s4 = s3.slice(0,i);
				s4 = s4.join("");
				if(al(s4) >= s2){
					if(i == 1 && s2 == 0){
						s4 = "";
					}
					break;
				}
			}
			q = q + s4.length + s1[0].length + 1;
		}
	}else{
		q = s.length;
	}

	if(bb){
		if(p.selectionDirection == "backward"){
			if(q > p.selectionEnd){
				p.setSelectionRange(p.selectionEnd,q,"forward");
			}else{
				p.selectionStart = q;
			}
		}else{
			p.selectionEnd = q;
		}
	}else{
		p.setSelectionRange(q,q);
	}
}

function h() { //……プレビュー
	var s = rg(1);
	var s1 = al(s,1);
	s = s.replace(/</gm,"&lt;");
	s = s.replace(/>/gm,"&gt;");
	s = s.replace(/\n/gm,"<br>");
	s = "<header>Preview[" + s1 + ']　<button type=button onclick="pc()">■</button><button type=button onclick="x()">×</button></header><p id="pid" onclick="pd()"' + pst + ">" + s + '</p><footer><button type=button onclick="hm()">「</button><button type=button onclick="pu()">↑</button><button type=button onclick="pd()">↓</button><button type=button onclick="ed()">」</button></footer>';
	w.innerHTML = s;
	w.style.display = "block";
	p.style.display = "none";
	document.getElementById("cn").style.display = "none";
}

function pc() { //……プレビューコピー
	if(window.confirm("プレビューをコピーしますか？")){
		p.style.display = "block";
		var s = rg(), a = p.value, q = p.selectionEnd;
		p.value = s;
		p.select();
		try{
			document.execCommand('copy');
			mp("コピーしました");
		}catch(e){
			alert("実行できませんでした\n" + e);
		}
		p.value = a;
		p.setSelectionRange(q,q);
		p.blur();
		p.style.display = "none";
	}
	
}

function rg(u) { //……置換処理
	var t = p.value;
	
	var s = localStorage.getItem('pps'); //プレビュー設定
	if(s != "" && s != null){
		s = s.split(":");
		if(s[6] == "true"){
			s = localStorage.getItem('ppv'); ///置換ルール
			var a = "", b = "", c = "", i = 0;
			if(s != "" && s != null){ //置換処理
				s = s.split("\n");
				for(i in s){
					if(/^\/\//.test(s[i]) || s[i] == ""){ //コメントと空行はスキップ
						continue;
					}
					a = s[i].split("\t");
					if(a.length < 3){ //要素不足は記録してスキップ
						i -= 0;
						c = c + (i + 1) + ",";
						continue;
					}
					b = new RegExp(a[0],a[1]);
					t = t.replace(b,a[2]);
				}
				if(c != "" && u == 1){
					c = c.slice(0,-1);
					alert(c + "行目をスキップしました。");
				}
			}
		}
	}
	return(t);
}

function hm() { //……プレビューhome
	window.scrollTo(0,0);
}

function pu() { //……プレビューpageup
	var s = window.innerHeight;
	s -= 93;
	window.scrollBy(0,s * -1);
}

function pd() { //……プレビューpagedown
	var s = window.innerHeight;
	s -= 93;
	window.scrollBy(0,s);
}

function ed() { //……プレビューend
	var s = document.documentElement.scrollHeight - document.documentElement.clientHeight;
	window.scrollTo(0,s);
}

function x() { //……プレビューを閉じる
	p.style.display = "block";
	document.getElementById("cn").style.display = "block";
	w.innerHTML = 0;
	w.style.display = "none";
}

function bu() { //……自動バックアップ
	var s = p.value;
	if(s != ""){
			localStorage.setItem('pvalue_bu',s);
	}
}

p = document.getElementById("pr"); //テキストエリアオブジェクト
w = document.getElementById("vw"); //プレビュー用オブジェクトdiv
wp = document.getElementById("pp"); //プレビュー用オブジェクトp
r = document.getElementById("swl"); //定型文選択用オブジェクト
pst = "";



/*	設定コメントアウト
										s = localStorage.getItem('prows'); //行数
										if(s >= 5 && s <= 20){
											document.getElementById("cr").value = s;
											p.rows = s;
										}
										s = localStorage.getItem('pfs'); //フォントサイズ
										if(s >= 8 && s <= 39){
											document.getElementById("ft").value = s;
											p.style.fontSize = s + "px";
										}else{
											p.style.fontSize = "13px";
										}
										s = localStorage.getItem('pls'); //字間
										if(s >= 0 && s <= 9 && s != null){
											document.getElementById("ls").value = s;
											p.style.letterSpacing = s + "px";
										}else{
											p.style.letterSpacing = "1px";
										}
										s = localStorage.getItem('plh'); //行間
										if(s >= 0 && s <= 200 && s != null){
											document.getElementById("lh").value = s;
											p.style.lineHeight = s + "%";
										}
										s = localStorage.getItem('pfc'); //文字色
										if(/^#[\da-f]{6}$/i.test(s)){
											document.getElementById("fc").value = s;
											p.style.color = s;
										}
										s = localStorage.getItem('pbc'); //背景色
										if(/^#[\da-f]{6}$/i.test(s)){
											document.getElementById("bc").value = s;
											p.style.backgroundColor = s;
										}
										s = localStorage.getItem('pbh'); //ボタン高さ
										if(s >= 11 && s <= 45){
											document.getElementById("bh").value = s;
											for (s1 = 0; s1 < 24; s1++) {
												document.getElementsByTagName("button")[s1].style.height = s + "px";
											}
											r.style.height = s + "px";
										}


										s = localStorage.getItem('pem'); //拡張スイッチ
										if(s == "true"){
											document.getElementById("em").checked = 1;
										}else{
											document.getElementById("cm").style.display = "block";
											document.getElementById("cf").style.display = "none";
										}

										s = localStorage.getItem('psc'); //定型文スイッチ
										if(s == "true"){
											document.getElementById("swg").style.display = "inline";
											document.getElementById("sc").checked = 1;
										}
	設定コメントアウト */

s = localStorage.getItem('pss');
if(s != "" && s != null){
	sh(s);
	s = s.split(":");
	document.getElementById("cr").value = s[0]; //テキストエリア高さ(行)
	document.getElementById("ft").value = s[1]; //フォントサイズ(px)
	document.getElementById("ls").value = s[2]; //字間(px)
	document.getElementById("lh").value = s[3]; //行間(%)
	document.getElementById("fc").value = s[4]; //文字色
	document.getElementById("bc").value = s[5]; //背景色
	document.getElementById("bh").value = s[6]; //ボタン高さ(px)
	if(s[7] == "true"){ //拡張スイッチ
		document.getElementById("em").checked = 1;
	}
	if(s[8] == "true"){ //定型文スイッチ
		document.getElementById("sc").checked = 1;
	}
}else{
	p.style.fontSize = "13px";
	p.style.letterSpacing = "1px";
	document.getElementById("cm").style.display = "block";
	document.getElementById("cf").style.display = "none";
}
s = localStorage.getItem('psw'); //定型文内容
if(s != "" && s != null){
	document.getElementById("sw").value = s;
	s = s.replace(/</g,"&lt;");
	s = s.replace(/>/g,"&gt;");
	s = s.replace(/^(.+)$/gm,"<option>$1</option>");
	r.innerHTML = s;
}

s = localStorage.getItem('pps'); //プレビュー設定
if(s != "" && s != null){
	hpr(s);
	s = s.split(":");
	document.getElementById("vff").value = s[0]; //フォントファミリー
	document.getElementById("vft").value = s[1]; //フォントサイズ(px)
	document.getElementById("vls").value = s[2]; //字間(px)
	document.getElementById("vlh").value = s[3]; //行間(%)
	document.getElementById("vfc").value = s[4]; //文字色
	document.getElementById("vbc").value = s[5]; //背景色
	if(s[6] == "true"){
		document.getElementById("vem").checked = 1; //置換
	}
}
s = localStorage.getItem('ppv'); ///置換ルール
if(s != null){
	document.getElementById("vsw").value = s;
}

s = localStorage.getItem('pn'); //メニュー状態復帰
if(s > 0){
	document.getElementById("pn").style.display = "block";
	document.getElementById("cn").style.display = "none";
}else{
	p.style.display = "block";
}

s = localStorage.getItem('pvalue_bu'); //自動バックアップから復帰
if(p.value == "" && s != null && s != ""){
		p.value = s;
}else{
	s = localStorage.getItem('pvalue'); //保存から復帰
	if(p.value == "" && s != null && s != ""){
		p.value = s;
	}
}

s = localStorage.getItem('wfl'); //webフォント使用状態
if(s > 0){
	p.style.fontFamily = '"emj","webnasm"';
	document.getElementById("wf").textContent = "終了";

}

bb = 0; //範囲選択モード初期値：オフ


//--></script>

</body>
</html>
